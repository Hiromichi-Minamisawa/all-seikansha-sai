<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>„ÇØ„Ç§„Ç∫Ëß£Á≠îÁîªÈù¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #f4f4f4;
      font-family: 'Inter', sans-serif;
      text-align: center;
      padding: 2rem;
    }

    .hidden {
      display: none;
    }

    #loginScreen {
      margin-top: 100px;
    }

    #nameInput {
      padding: 1rem;
      font-size: 1.5rem;
      width: 80%;
      max-width: 400px;
      margin-bottom: 1rem;
    }
    
    #idInput {
      padding: 1rem;
      font-size: 1.5rem;
      width: 80%;
      max-width: 400px;
      margin-bottom: 1rem;
    }

    #loginButton {
      padding: 1rem 2rem;
      font-size: 1.5rem;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    #standby {
      font-size: 2rem;
      margin-top: 3rem;
    }

    #choices {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 1rem;
      width: 100%;
      max-width: 600px;
      margin: 2rem auto;
    }

    .choice {
      padding: 4rem;
      font-size: 2rem;
      font-weight: bold;
      border-radius: 20px;
      color: white;
      cursor: pointer;
    }

    .choice.selected {
      border: 4px solid #333;
    }

    .choice:nth-child(1) { background-color: #0B17FF; }
    .choice:nth-child(2) { background-color: #FF060A; }
    .choice:nth-child(3) { background-color: #028F0B; }
    .choice:nth-child(4) { background-color: #E4DD1D; color: black; }

    .result {
      font-size: 2rem;
      margin-top: 2rem;
      font-weight: bold;
    }

    .correct {
      color: green;
    }

    .incorrect {
      color: red;
    }
  </style>
</head>
<body>

  <!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
  <div id="loginScreen">
    <input id="nameInput" type="text" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" />
    <br />
    <input id="idInput" type="text" placeholder="Á§æÂì°Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" />
    <br />
    <button id="loginButton">„É≠„Ç∞„Ç§„É≥</button>
  </div>

  <!-- „ÇØ„Ç§„Ç∫ÁîªÈù¢ -->
  <div id="questionArea" class="hidden">
    <div id="standby"></div>
    <div id="choices"></div>
  </div>

  <div class="result" id="result"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      set,
      get
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAi5sKHLYDr_h4uq0AmLXTDD_hevG3kOJQ",
      authDomain: "all-seikanshasai.firebaseapp.com",
      databaseURL: "https://all-seikanshasai-default-rtdb.firebaseio.com",
      projectId: "all-seikanshasai",
      storageBucket: "all-seikanshasai.appspot.com",
      messagingSenderId: "24572064606",
      appId: "1:24572064606:web:a7f94b0561333f272055cf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    let userName = "";
    let userId = "";
    let currentQuestion = null;
    let hasAnswered = false;
    let selectedIndex = null;
    let hasStarted = false;
    
    const loginScreen = document.getElementById("loginScreen");
    const nameInput = document.getElementById("nameInput");
    const idInput = document.getElementById("idInput");
    const loginButton = document.getElementById("loginButton");
    const questionArea = document.getElementById("questionArea");
    const standbyEl = document.getElementById("standby");
    const choicesEl = document.getElementById("choices");
    const resultEl = document.getElementById("result");
    
    loginButton.onclick = async () => {
      const id = document.getElementById("idInput").value.trim();
      const name = nameInput.value.trim();
      console.log("„É≠„Ç∞„Ç§„É≥Ë©¶Ë°åÔºö", id, name);
      if (!id || !name) {
        alert("5Ê°Å„ÅÆÁ§æÂì°Áï™Âè∑„Å®ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        return;
      }
      
      const allowedSnap = await get(ref(db, `allowedUsers/${id}`));
      const allowedName = allowedSnap.val();
      console.log("allowedName:", allowedName);
      
      if (!allowedName || allowedName !== name) {
        alert("Á§æÂì°Áï™Âè∑„Åæ„Åü„ÅØÂêçÂâç„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì");
        return;
      }
      
      const participantsRef = ref(db, "participants");
      const snap = await get(participantsRef);
      const participants = snap.val() || {};
      const nameExists = Object.values(participants).some(p => p.name === name);

      if (nameExists) {
        alert("„Åì„ÅÆÂêçÂâç„ÅØ„Åô„Åß„Å´‰Ωø„Çè„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÂà•„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
        return;
      }
      
      userId = id;
      userName = name;
      localStorage.setItem("quizUserName", userName);
      localStorage.setItem("quizUserId", userId);
      await set(ref(db, `participants/${userId}`), {
        name: userName,
        timestamp: Date.now()
      });

      loginScreen.classList.add("hidden");
      questionArea.classList.remove("hidden");
      standbyEl.textContent = "„Çà„ÅÜ„Åì„ÅùÔºÅ  „ÇØ„Ç§„Ç∫„ÅåÂßã„Åæ„Çã„Åæ„Åß„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ";
    };
    
    // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò„Åï„Çå„ÅüÂêçÂâç„Åå„ÅÇ„Çå„Å∞Âæ©ÂÖÉ
    const savedName = localStorage.getItem("quizUserName");
    const savedId = localStorage.getItem("quizUserId");
    if (savedName && savedId) {
      const participantRef = ref(db, `participants/${savedId}`);
      get(participantRef).then((snapshot) => {
        if (snapshot.exists()) {
          userName = savedName;
          userId = savedId
          loginScreen.classList.add("hidden");
          questionArea.classList.remove("hidden");
          standbyEl.textContent = "„Çà„ÅÜ„Åì„ÅùÔºÅ  „ÇØ„Ç§„Ç∫„ÅåÂßã„Åæ„Çã„Åæ„Åß„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ";
        } else {
          localStorage.removeItem("quizUserName");
          localStorage.removeItem("quizUserId");
          loginScreen.classList.remove("hidden");
          questionArea.classList.add("hidden");
        }
      });
    }

    onValue(ref(db, "mode"), (snapshot) => {
      const mode = snapshot.val();
      if (mode === "quiz" && currentQuestion) {
        standbyEl.style.display = "none";
        choicesEl.style.display = "grid";
      } else {
        standbyEl.style.display = "block";
        standbyEl.textContent = hasStarted
          ? "ÂïèÈ°åÂá∫È°å„Åæ„Åß„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ"
          : "„ÇØ„Ç§„Ç∫„ÅåÂßã„Åæ„Çã„Åæ„Åß„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ";
        choicesEl.style.display = "none";
        choicesEl.innerHTML = "";
        resultEl.textContent = "";
        currentQuestion = null;
        hasAnswered = false;
      }
    });
    
    onValue(ref(db, "currentQuestion"), async (snapshot) => {
      const data = snapshot.val();
      if (!data || typeof data.correct !== "number" || !data.screen) return;
      hasStarted = true;
      currentQuestion = data;
      hasAnswered = false;
      selectedIndex = null;
      resultEl.textContent = "";
      choicesEl.innerHTML = "";
          
          const key = data.screen.replace(/\./g, "_");
          const noVoteSnap = await get(ref(db, `noVoteUsers/${key}`));
          const noVoteList = noVoteSnap.val() || {};
          const isBanned = !!noVoteList[userId];
          if (isBanned) {
            standbyEl.style.display = "block";
            standbyEl.textContent = "„Åì„ÅÆÂïèÈ°å„ÅØ„ÅÇ„Å™„Åü„ÅØÊäïÁ•®„Åß„Åç„Åæ„Åõ„Çì„ÄÇ";
            choicesEl.style.display = "none";
            return;
          }
          
      ["1", "2", "3", "4"].forEach((label, index) => {
        const div = document.createElement("div");
        div.className = "choice";
        div.textContent = label;
        div.onclick = () => {
          if (hasAnswered) return;
          hasAnswered = true;
          selectedIndex = index;

          document.querySelectorAll(".choice").forEach((el, i) => {
            el.classList.toggle("selected", i === index);
            el.style.pointerEvents = "none";
            el.style.opacity = "0.5";
          });

          set(ref(db, `answers/${userId}`), {
            name: userName,
            choice: index,
            timestamp: Date.now(),
            timeTaken: Date.now() - currentQuestion.startTime // ‚Üê „Åì„Çå„ÅåËß£Á≠îÊôÇÈñìÔºàmsÔºâ
          });
        };
        choicesEl.appendChild(div);
      });

      // ‚è± Ëá™ÂãïÁ∑†ÂàáÂá¶ÁêÜÔºàÂà∂ÈôêÊôÇÈñìÂæå„Å´ÈÅ∏ÊäûËÇ¢„ÇíÁÑ°ÂäπÂåñÔºâ
      const startTime = data.startTime || Date.now();
      const duration = data.duration || 15000;
      const remaining = startTime + duration - Date.now();

      setTimeout(() => {
        if (!hasAnswered) {
          document.querySelectorAll(".choice").forEach((el) => {
            el.style.pointerEvents = "none";
            el.style.opacity = "0.5";
          });
        }
      }, remaining > 0 ? remaining : 0);
    });

    onValue(ref(db, "showCorrect"), async (snapshot) => {
      const show = snapshot.val();
      if (show && currentQuestion && selectedIndex !== null) {
        const screen = currentQuestion.screen;
        if (!screen) return;

        const key = screen.replace(/\./g, "_");
        const correctSnap = await get(ref(db, `correctAnswers/${key}`));
        const correctIndex = Number(correctSnap.val()) - 1;
        
        if (selectedIndex === correctIndex) {
          resultEl.textContent = "„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ„ÄÄÊ≠£Ëß£„Åß„ÅôÔºÅüéâ";
          resultEl.className = "result correct";
        } else {
          resultEl.textContent = "„Åñ„Çì„Å≠„ÇìÔºÅ ‰∏çÊ≠£Ëß£„Åß„Åô...üòì";
          resultEl.className = "result incorrect";
        }
      } else {
        resultEl.textContent = "";
      }
    });
  </script>
</body>
</html>
